local Players = game:GetService("Players")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local CONFIG = {
    SPAM_DELAY = 0.02,
    PROCESS_DURATION = 0.2,
    CHECK_LOAD_TIME = 3,
    COOLDOWN_TIME = 10,
    STARTUP_WAIT_1 = 1,
    STARTUP_WAIT_2 = 2,
    LOAD_DISTANCE_THRESHOLD = 200,
    LOAD_WAIT_TIME = 3,
    BUTTON_MONEY_WAIT = 10,
    MAX_LONG_TELEPORTS = 2,
}

local isRunning = false
local startupComplete = false
local longTeleportCount = 0

-- GUI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BankAuto"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 140, 0, 50)
button.Position = UDim2.new(0, 20, 0.5, -25)
button.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
button.Text = "START AUTO"
button.TextColor3 = Color3.new(1, 1, 1)
button.TextSize = 18
button.Font = Enum.Font.SourceSansBold
button.Parent = screenGui

Instance.new("UICorner", button).CornerRadius = UDim.new(0, 6)

function updateButton()
    if isRunning then
        button.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
        button.Text = "STOP"
    else
        button.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
        button.Text = "START AUTO"
    end
end

function resetCamera()
    camera.CameraType = Enum.CameraType.Custom
end

-- Ensure HRP exists
local function getHRP()
    local char = player.Character
    if char then
        return char:FindFirstChild("HumanoidRootPart")
    end
    return nil
end

local function ensureHRP()
    while isRunning do
        local hrp = getHRP()
        if hrp then return hrp end
        task.wait(0.1)
    end
    return nil
end

-- Standard teleport (no limit, for cooldown/startup)
local function tpCoords(pos)
    local hrp = ensureHRP()
    if not hrp then return false end
    hrp.CFrame = CFrame.new(pos.X, pos.Y, pos.Z)
    return true
end

-- Limited teleport - counts toward 200-stud limit
local function tpLimited(pos)
    local hrp = ensureHRP()
    if not hrp then return false, "NO_HRP" end
    
    local distance = (hrp.Position - pos).Magnitude
    
    if distance > CONFIG.LOAD_DISTANCE_THRESHOLD then
        if longTeleportCount >= CONFIG.MAX_LONG_TELEPORTS then
            return false, "LIMIT"
        end
        longTeleportCount = longTeleportCount + 1
        
        button.Text = "LOADING..."
        task.wait(CONFIG.LOAD_WAIT_TIME)
    end
    
    hrp.CFrame = CFrame.new(pos.X, pos.Y, pos.Z)
    return true
end

-- Limited part teleport
local function tpPartLimited(part)
    local hrp = ensureHRP()
    if not hrp or not part then return false, "INVALID" end
    
    local distance = (hrp.Position - part.Position).Magnitude
    
    if distance > CONFIG.LOAD_DISTANCE_THRESHOLD then
        if longTeleportCount >= CONFIG.MAX_LONG_TELEPORTS then
            return false, "LIMIT"
        end
        longTeleportCount = longTeleportCount + 1
    end
    
    hrp.CFrame = CFrame.new(part.Position + Vector3.new(0, 3, 0))
    camera.CameraType = Enum.CameraType.Scriptable
    camera.CFrame = CFrame.new(part.Position + Vector3.new(0, 4, 0), part.Position)
    
    return true
end

local function firePrompt(prompt)
    if not prompt or not prompt:IsA("ProximityPrompt") then return end
    prompt:InputHoldBegin()
    prompt:InputHoldEnd()
end

local function spamPrompt(prompt)
    if not prompt then return end
    local start = tick()
    while isRunning and (tick() - start) < CONFIG.PROCESS_DURATION do
        firePrompt(prompt)
        task.wait(CONFIG.SPAM_DELAY)
    end
end

-- Robbery target functions
local function getBankButton()
    local bank = workspace:FindFirstChild("BANK")
    if not bank then return nil, nil end
    local panel = bank:FindFirstChild("ButtonPanel")
    if not panel then return nil, nil end
    local pPart = panel:FindFirstChild("PromptPart")
    if not pPart then return nil, nil end
    return pPart:FindFirstChild("ProximityPrompt"), pPart
end

local function getNearestMoney()
    local bank = workspace:FindFirstChild("BANK")
    if not bank then return nil, nil end
    local boxes = bank:FindFirstChild("MoneyBoxes")
    if not boxes then return nil, nil end
    
    local hrp = getHRP()
    if not hrp then return nil, nil end
    
    local hrpPos = hrp.Position
    local nearestPrompt, nearestPart, shortestDist = nil, nil, math.huge
    
    for _, box in ipairs(boxes:GetChildren()) do
        local pp = box:FindFirstChild("PromptPart")
        if pp then
            local prompt = pp:FindFirstChild("ProximityPrompt")
            if prompt and prompt.Enabled then
                local dist = (hrpPos - pp.Position).Magnitude
                if dist < shortestDist then
                    shortestDist = dist
                    nearestPrompt = prompt
                    nearestPart = pp
                end
            end
        end
    end
    return nearestPrompt, nearestPart
end

local function isMuseumOpen()
    local museum = workspace:FindFirstChild("MUSEUM")
    if not museum then return false end
    if museum:FindFirstChild("MuseumDoor") then
        return false
    end
    return true
end

local function getNearestArt()
    local museum = workspace:FindFirstChild("MUSEUM")
    if not museum then return nil, nil end
    local artFolder = museum:FindFirstChild("Art")
    if not artFolder then return nil, nil end
    
    local hrp = getHRP()
    if not hrp then return nil, nil end
    
    local hrpPos = hrp.Position
    local nearestPrompt, nearestPart, shortestDist = nil, nil, math.huge
    
    for _, artModel in ipairs(artFolder:GetChildren()) do
        local mainPart = artModel:FindFirstChild("MainPart")
        if mainPart then
            local prompt = mainPart:FindFirstChild("ProximityPrompt")
            if prompt and prompt.Enabled then
                local dist = (hrpPos - mainPart.Position).Magnitude
                if dist < shortestDist then
                    shortestDist = dist
                    nearestPrompt = prompt
                    nearestPart = mainPart
                end
            end
        end
    end
    return nearestPrompt, nearestPart
end

-- Process target (respects teleport limit)
local function processTarget(part, prompt)
    if not isRunning then return false end
    
    local ok, status = tpPartLimited(part)
    if not ok then return false, status end
    
    local originalHold = prompt.HoldDuration
    prompt.HoldDuration = 0
    
    spamPrompt(prompt)
    
    if prompt.Parent then
        prompt.HoldDuration = originalHold
    end
    
    return true
end

-- Cooldown cycle (resets counter)
local function doCooldown()
    if not isRunning then return end
    
    resetCamera()
    tpCoords(Vector3.new(1034, -2, 174))
    button.Text = "COOLDOWN"
    task.wait(CONFIG.COOLDOWN_TIME)
    
    -- Reset counter after cooldown
    longTeleportCount = 0
    
    -- Return to bank start position
    if isRunning then
        tpCoords(Vector3.new(917, 3, 2589))
        task.wait(CONFIG.CHECK_LOAD_TIME)
    end
end

-- Main Logic
local function autoRob()
    -- Reset counter
    longTeleportCount = 0
    
    -- INITIAL STARTUP (bypasses limit)
    if not startupComplete then
        button.Text = "STARTUP"
        
        tpCoords(Vector3.new(980, 2, 541))
        task.wait(CONFIG.STARTUP_WAIT_1)
        
        if isRunning then
            tpCoords(Vector3.new(917, 3, 2589))
            task.wait(CONFIG.STARTUP_WAIT_2)
        end
        
        startupComplete = true
        longTeleportCount = 0
    end
    
    -- Main loop
    while isRunning do
        -- PHASE 1: BANK
        button.Text = "BANK"
        local ok = tpLimited(Vector3.new(917, 3, 2589))
        
        if not ok then
            -- Hit limit, go cooldown immediately
            doCooldown()
            continue -- Skip rest of this loop iteration
        end
        
        task.wait(CONFIG.CHECK_LOAD_TIME)
        
        local btnPrompt, btnPart = getBankButton()
        local moneyExists = getNearestMoney()
        
        if (btnPrompt and btnPrompt.Enabled) or moneyExists then
            
            -- Button?
            if btnPrompt and btnPrompt.Enabled then
                button.Text = "BUTTON"
                processTarget(btnPart, btnPrompt)
                
                -- Money collection mode (10s min)
                local startTime = tick()
                while isRunning do
                    local elapsed = tick() - startTime
                    local mPrompt, mPart = getNearestMoney()
                    
                    if mPrompt then
                        button.Text = "MONEY"
                        local ok2, stat = processTarget(mPart, mPrompt)
                        if not ok2 and stat == "LIMIT" then
                            break -- Hit limit, exit to cooldown
                        end
                        task.wait()
                    else
                        if elapsed >= CONFIG.BUTTON_MONEY_WAIT then
                            break
                        else
                            button.Text = "WAIT " .. math.ceil(10 - elapsed)
                            task.wait(0.5)
                        end
                    end
                end
                
            -- Just money (no button)
            elseif moneyExists then
                while isRunning do
                    local mPrompt, mPart = getNearestMoney()
                    if not mPrompt then break end
                    
                    button.Text = "MONEY"
                    local ok2, stat = processTarget(mPart, mPrompt)
                    if not ok2 and stat == "LIMIT" then
                        break
                    end
                    task.wait()
                end
            end
        end
        
        if not isRunning then break end
        
        -- PHASE 2: MUSEUM
        button.Text = "MUSEUM"
        local ok3 = tpLimited(Vector3.new(109, 3, 1866))
        
        if not ok3 then
            -- Used both teleports already, cooldown now
            doCooldown()
            continue -- Skip rest, start fresh from bank
        end
        
        task.wait(CONFIG.CHECK_LOAD_TIME)
        
        if isMuseumOpen() then
            while isRunning do
                local artPrompt, artPart = getNearestArt()
                if not artPrompt then break end
                
                button.Text = "ART"
                local ok4, stat = processTarget(artPart, artPrompt)
                if not ok4 and stat == "LIMIT" then
                    break -- Hit limit during art collection
                end
                task.wait()
            end
        else
            button.Text = "DOOR CLOSED"
            task.wait(1)
        end
        
        if not isRunning then break end
        
        -- PHASE 3: COOLDOWN (always happens after processing both locations)
        doCooldown()
    end
    
    resetCamera()
    updateButton()
    button.Text = "START AUTO"
end

-- Toggle
button.MouseButton1Click:Connect(function()
    isRunning = not isRunning
    
    if isRunning then
        updateButton()
        task.spawn(autoRob)
    else
        updateButton()
        resetCamera()
    end
end)

-- Handle death
player.CharacterAdded:Connect(function(char)
    resetCamera()
    task.spawn(function()
        char:WaitForChild("HumanoidRootPart", 5)
    end)
end)

print("[AUTO] Loaded")
