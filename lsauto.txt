local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local CONFIG = {
    SPAM_DELAY = 0.02,
    PROCESS_DURATION = 0.3,
    CHECK_LOAD_TIME = 0,
    COOLDOWN_TIME = 9,
    STARTUP_WAIT_1 = 1,
    STARTUP_WAIT_2 = 0,
    LOAD_DISTANCE_THRESHOLD = 200,
    LOAD_WAIT_TIME = 1,
    BUTTON_MONEY_WAIT = 20,
    MAX_LONG_TELEPORTS = 2,
    RESET_ATTEMPT_INTERVAL = 0.3,
}

local isRunning = false
local startupComplete = false
local longTeleportCount = 0

-- Precomputed squared distance threshold
local LOAD_DIST_SQ = CONFIG.LOAD_DISTANCE_THRESHOLD * CONFIG.LOAD_DISTANCE_THRESHOLD

-- Constant target positions reused (no functional change)
local BANK_POS = Vector3.new(917, 3, 2589)
local STARTUP_POS = Vector3.new(980, 2, 541)
local MUSEUM_POS = Vector3.new(109, 3, 1866)

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BankAuto"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 140, 0, 50)
button.Position = UDim2.new(0, 20, 0.5, -25)
button.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
button.Text = "START AUTO"
button.TextColor3 = Color3.new(1, 1, 1)
button.TextSize = 18
button.Font = Enum.Font.SourceSansBold
button.Parent = screenGui

Instance.new("UICorner", button).CornerRadius = UDim.new(0, 6)

local function setButtonText(txt)
    if button.Text ~= txt then
        button.Text = txt
    end
end

function updateButton()
    if isRunning then
        button.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
        setButtonText("STOP")
    else
        button.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
        setButtonText("START AUTO")
    end
end

local function resetCamera()
    if camera.CameraType ~= Enum.CameraType.Custom then
        camera.CameraType = Enum.CameraType.Custom
    end
end

local function getHRP()
    local char = player.Character
    if char then
        return char:FindFirstChild("HumanoidRootPart")
    end
    return nil
end

local function getHumanoid()
    local char = player.Character
    if char then
        return char:FindFirstChild("Humanoid")
    end
    return nil
end

local function ensureHRP()
    while isRunning do
        local hrp = getHRP()
        if hrp then return hrp end
        task.wait(0.1)
    end
    return nil
end

local function distSq(a, b)
    local dx, dy, dz = a.X - b.X, a.Y - b.Y, a.Z - b.Z
    return dx*dx + dy*dy + dz*dz
end

local function isLongTeleport(targetPos)
    local hrp = getHRP()
    if not hrp then return false end
    return distSq(hrp.Position, targetPos) > LOAD_DIST_SQ
end

local function tpCoords(pos)
    local hrp = ensureHRP()
    if not hrp then return false end
    hrp.CFrame = CFrame.new(pos.X, pos.Y, pos.Z)
    return true
end

local function tpLimited(pos)
    local hrp = ensureHRP()
    if not hrp then return false, "NO_HRP" end

    local distanceSq = distSq(hrp.Position, pos)

    if distanceSq > LOAD_DIST_SQ then
        if longTeleportCount >= CONFIG.MAX_LONG_TELEPORTS then
            setButtonText("LIMIT REACHED")
            return false, "LIMIT_HIT"
        end
        longTeleportCount = longTeleportCount + 1

        setButtonText("LOADING...")
        task.wait(CONFIG.LOAD_WAIT_TIME)
    end

    hrp.CFrame = CFrame.new(pos.X, pos.Y, pos.Z)
    return true, "OK"
end

local function tpToPart(part)
    local hrp = ensureHRP()
    if not hrp or not part then return false, "INVALID" end

    local distanceSq = distSq(hrp.Position, part.Position)

    if distanceSq > LOAD_DIST_SQ then
        if longTeleportCount >= CONFIG.MAX_LONG_TELEPORTS then
            return false, "LIMIT_HIT"
        end
        longTeleportCount = longTeleportCount + 1
    end

    hrp.CFrame = CFrame.new(part.Position + Vector3.new(0, 3, 0))
    if camera.CameraType ~= Enum.CameraType.Scriptable then
        camera.CameraType = Enum.CameraType.Scriptable
    end
    camera.CFrame = CFrame.new(part.Position + Vector3.new(0, 4, 0), part.Position)

    return true, "OK"
end

local function firePrompt(prompt)
    if not prompt or not prompt:IsA("ProximityPrompt") then return end
    fireproximityprompt(prompt)
end

local function spamPrompt(prompt)
    if not prompt then return end
    local start = tick()
    while isRunning and (tick() - start) < CONFIG.PROCESS_DURATION do
        firePrompt(prompt)
        task.wait(CONFIG.SPAM_DELAY)
    end
end

local function getBankButton()
    local bank = workspace:FindFirstChild("BANK")
    if not bank then return nil, nil end
    local panel = bank:FindFirstChild("ButtonPanel")
    if not panel then return nil, nil end
    local pPart = panel:FindFirstChild("PromptPart")
    if not pPart then return nil, nil end
    return pPart:FindFirstChild("ProximityPrompt"), pPart
end

local function getNearestMoney()
    local bank = workspace:FindFirstChild("BANK")
    if not bank then return nil, nil end
    local boxes = bank:FindFirstChild("MoneyBoxes")
    if not boxes then return nil, nil end

    local hrp = getHRP()
    if not hrp then return nil, nil end

    local hrpPos = hrp.Position
    local nearestPrompt, nearestPart, shortestDist = nil, nil, math.huge

    local children = boxes:GetChildren()
    for _, box in ipairs(children) do
        local pp = box:FindFirstChild("PromptPart")
        if pp then
            local prompt = pp:FindFirstChild("ProximityPrompt")
            if prompt and prompt.Enabled then
                local d = distSq(hrpPos, pp.Position)
                if d < shortestDist then
                    shortestDist = d
                    nearestPrompt = prompt
                    nearestPart = pp
                end
            end
        end
    end
    return nearestPrompt, nearestPart
end

local function isMuseumOpen()
    local museum = workspace:FindFirstChild("MUSEUM")
    if not museum then return false end
    if museum:FindFirstChild("MuseumDoor") then
        return false
    end
    return true
end

local function getNearestArt()
    local museum = workspace:FindFirstChild("MUSEUM")
    if not museum then return nil, nil end
    local artFolder = museum:FindFirstChild("Art")
    if not artFolder then return nil, nil end

    local hrp = getHRP()
    if not hrp then return nil, nil end

    local hrpPos = hrp.Position
    local nearestPrompt, nearestPart, shortestDist = nil, nil, math.huge

    local children = artFolder:GetChildren()
    for _, artModel in ipairs(children) do
        local mainPart = artModel:FindFirstChild("MainPart")
        if mainPart then
            local prompt = mainPart:FindFirstChild("ProximityPrompt")
            if prompt and prompt.Enabled then
                local d = distSq(hrpPos, mainPart.Position)
                if d < shortestDist then
                    shortestDist = d
                    nearestPrompt = prompt
                    nearestPart = mainPart
                end
            end
        end
    end
    return nearestPrompt, nearestPart
end

local function processTarget(part, prompt)
    if not isRunning then return false end

    local ok, status = tpToPart(part)
    if not ok then return false, status end

    local originalHold = prompt.HoldDuration
    prompt.HoldDuration = 0

    spamPrompt(prompt)

    if prompt.Parent then
        prompt.HoldDuration = originalHold
    end

    return true
end

local function resetCharacter()
    local WeaponEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("WeaponEvent")
    WeaponEvent:FireServer("Reset")
end

local function doCooldown()
    if not isRunning then return end

    setButtonText("RESETTING")
    
    -- Attempt reset every CONFIG.RESET_ATTEMPT_INTERVAL until health hits 0 or character changes
    while isRunning do
        local humanoid = getHumanoid()
        if humanoid and humanoid.Health <= 0 then
            break -- Stop resetting once health hits 0
        end
        
        resetCharacter()
        task.wait(CONFIG.RESET_ATTEMPT_INTERVAL)
    end
    
    -- Wait for new character to spawn and fully load
    local char = player.Character
    if not char then
        player.CharacterAdded:Wait()
        char = player.Character
    end
    
    if char then
        char:WaitForChild("HumanoidRootPart", 5)
        char:WaitForChild("Humanoid", 5)
    end
    
    -- Reset camera properly
    resetCamera()
    camera.CameraSubject = char and char:FindFirstChild("Humanoid") or nil

    -- Now start the cooldown timer after respawn is confirmed
    setButtonText("COOLDOWN")
    task.wait(CONFIG.COOLDOWN_TIME)

    longTeleportCount = 0

    if isRunning then
        tpLimited(BANK_POS)
        task.wait(CONFIG.CHECK_LOAD_TIME)
    end
end

local function autoRob()
    longTeleportCount = 0

    if not startupComplete then
        setButtonText("STARTUP")

        tpCoords(STARTUP_POS)
        task.wait(CONFIG.STARTUP_WAIT_1)

        if isRunning then
            tpCoords(BANK_POS)
            task.wait(CONFIG.STARTUP_WAIT_2)
        end

        startupComplete = true
        longTeleportCount = 0
    end

    while isRunning do
        local limitReached = false

        setButtonText("CHECK BANK")
        local success, status = tpLimited(BANK_POS)

        if not success and status == "LIMIT_HIT" then
            doCooldown()
        else
            task.wait(CONFIG.CHECK_LOAD_TIME)

            local btnPrompt, btnPart = getBankButton()
            local moneyExists = getNearestMoney()

            if (btnPrompt and btnPrompt.Enabled) or moneyExists then

                if btnPrompt and btnPrompt.Enabled then
                    setButtonText("BUTTON")
                    processTarget(btnPart, btnPrompt)

                    local startTime = tick()
                    while isRunning do
                        local elapsed = tick() - startTime
                        local mPrompt, mPart = getNearestMoney()

                        if mPrompt then
                            setButtonText("MONEY")
                            local ok, stat = processTarget(mPart, mPrompt)
                            if not ok and stat == "LIMIT_HIT" then
                                limitReached = true
                                break
                            end
                            task.wait()
                        else
                            if elapsed >= CONFIG.BUTTON_MONEY_WAIT then
                                break
                            else
                                setButtonText("WAIT " .. math.ceil(CONFIG.BUTTON_MONEY_WAIT - elapsed))
                                task.wait(0.5)
                            end
                        end
                    end

                elseif moneyExists then
                    while isRunning do
                        local mPrompt, mPart = getNearestMoney()
                        if not mPrompt then break end

                        setButtonText("MONEY")
                        local ok, stat = processTarget(mPart, mPrompt)
                        if not ok and stat == "LIMIT_HIT" then
                            limitReached = true
                            break
                        end
                        task.wait()
                    end
                end
            end

            if isRunning and not limitReached then
                setButtonText("CHECK MUSEUM")
                local ok2, stat2 = tpLimited(MUSEUM_POS)

                if not ok2 and stat2 == "LIMIT_HIT" then
                    limitReached = true
                else
                    task.wait(CONFIG.CHECK_LOAD_TIME)

                    if isMuseumOpen() then
                        local artPrompt, artPart = getNearestArt()

                        if artPrompt then
                            setButtonText("ART")
                            local ok3, stat3 = processTarget(artPart, artPrompt)
                            if not ok3 and stat3 == "LIMIT_HIT" then
                                limitReached = true
                            else
                                while isRunning and not limitReached do
                                    local nextPrompt, nextPart = getNearestArt()
                                    if not nextPrompt then break end

                                    setButtonText("ART")
                                    local ok4, stat4 = processTarget(nextPart, nextPrompt)
                                    if not ok4 and stat4 == "LIMIT_HIT" then
                                        limitReached = true
                                        break
                                    end
                                    task.wait()
                                end
                            end
                        else
                            setButtonText("NO ART")
                            task.wait(0.1)
                        end
                    else
                        setButtonText("DOOR CLOSED")
                        task.wait(1)
                    end
                end
            end

            if isRunning then
                doCooldown()
            end
        end
    end

    resetCamera()
    updateButton()
    setButtonText("START AUTO")
end

button.MouseButton1Click:Connect(function()
    isRunning = not isRunning

    if isRunning then
        updateButton()
        task.spawn(autoRob)
    else
        updateButton()
        resetCamera()
    end
end)

player.CharacterAdded:Connect(function(char)
    resetCamera()
    task.spawn(function()
        char:WaitForChild("HumanoidRootPart", 5)
    end)
end)

