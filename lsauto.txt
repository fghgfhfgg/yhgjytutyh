local Players = game:GetService("Players")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local CONFIG = {
    SPAM_DELAY = 0.02,
    PROCESS_DURATION = 0.3,
    CHECK_LOAD_TIME = 0,
    COOLDOWN_TIME = 9,
    STARTUP_WAIT_1 = 1,
    STARTUP_WAIT_2 = 0,
    LOAD_DISTANCE_THRESHOLD = 200,
    LOAD_WAIT_TIME = 1,
    BUTTON_MONEY_WAIT = 20,
    MAX_LONG_TELEPORTS = 2,
}

local isRunning = false
local startupComplete = false
local longTeleportCount = 0

-- GUI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BankAuto"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 140, 0, 50)
button.Position = UDim2.new(0, 20, 0.5, -25)
button.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
button.Text = "START AUTO"
button.TextColor3 = Color3.new(1, 1, 1)
button.TextSize = 18
button.Font = Enum.Font.SourceSansBold
button.Parent = screenGui

Instance.new("UICorner", button).CornerRadius = UDim.new(0, 6)

function updateButton()
    if isRunning then
        button.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
        button.Text = "STOP"
    else
        button.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
        button.Text = "START AUTO"
    end
end

function resetCamera()
    camera.CameraType = Enum.CameraType.Custom
end

-- Ensure HRP exists
local function getHRP()
    local char = player.Character
    if char then
        return char:FindFirstChild("HumanoidRootPart")
    end
    return nil
end

local function ensureHRP()
    while isRunning do
        local hrp = getHRP()
        if hrp then return hrp end
        task.wait(0.1)
    end
    return nil
end

-- Check if position is far ( >200 studs)
local function isLongTeleport(targetPos)
    local hrp = getHRP()
    if not hrp then return false end
    return (hrp.Position - targetPos).Magnitude > CONFIG.LOAD_DISTANCE_THRESHOLD
end

-- Standard teleport (no limit tracking - for cooldown/startup)
local function tpCoords(pos)
    local hrp = ensureHRP()
    if not hrp then return false end
    hrp.CFrame = CFrame.new(pos.X, pos.Y, pos.Z)
    return true
end

-- Limited teleport (tracks >200 stud jumps)
local function tpLimited(pos)
    local hrp = ensureHRP()
    if not hrp then return false, "NO_HRP" end
    
    local distance = (hrp.Position - pos).Magnitude
    
    -- Check if this counts as a long teleport
    if distance > CONFIG.LOAD_DISTANCE_THRESHOLD then
        if longTeleportCount >= CONFIG.MAX_LONG_TELEPORTS then
            button.Text = "LIMIT REACHED"
            return false, "LIMIT_HIT"
        end
        longTeleportCount = longTeleportCount + 1
        
        -- Wait for area load
        button.Text = "LOADING..."
        task.wait(CONFIG.LOAD_WAIT_TIME)
    end
    
    hrp.CFrame = CFrame.new(pos.X, pos.Y, pos.Z)
    return true, "OK"
end

-- Part teleport with camera (tracks distance too)
local function tpToPart(part)
    local hrp = ensureHRP()
    if not hrp or not part then return false, "INVALID" end
    
    local distance = (hrp.Position - part.Position).Magnitude
    
    if distance > CONFIG.LOAD_DISTANCE_THRESHOLD then
        if longTeleportCount >= CONFIG.MAX_LONG_TELEPORTS then
            return false, "LIMIT_HIT"
        end
        longTeleportCount = longTeleportCount + 1
    end
    
    hrp.CFrame = CFrame.new(part.Position + Vector3.new(0, 3, 0))
    camera.CameraType = Enum.CameraType.Scriptable
    camera.CFrame = CFrame.new(part.Position + Vector3.new(0, 4, 0), part.Position)
    
    return true, "OK"
end

local function firePrompt(prompt)
    if not prompt or not prompt:IsA("ProximityPrompt") then return end
    fireproximityprompt(prompt)
end

local function spamPrompt(prompt)
    if not prompt then return end
    local start = tick()
    while isRunning and (tick() - start) < CONFIG.PROCESS_DURATION do
        firePrompt(prompt)
        task.wait()
    end
end

-- Get Bank Button
local function getBankButton()
    local bank = workspace:FindFirstChild("BANK")
    if not bank then return nil, nil end
    local panel = bank:FindFirstChild("ButtonPanel")
    if not panel then return nil, nil end
    local pPart = panel:FindFirstChild("PromptPart")
    if not pPart then return nil, nil end
    return pPart:FindFirstChild("ProximityPrompt"), pPart
end

-- Get Nearest Money
local function getNearestMoney()
    local bank = workspace:FindFirstChild("BANK")
    if not bank then return nil, nil end
    local boxes = bank:FindFirstChild("MoneyBoxes")
    if not boxes then return nil, nil end
    
    local hrp = getHRP()
    if not hrp then return nil, nil end
    
    local hrpPos = hrp.Position
    local nearestPrompt, nearestPart, shortestDist = nil, nil, math.huge
    
    for _, box in ipairs(boxes:GetChildren()) do
        local pp = box:FindFirstChild("PromptPart")
        if pp then
            local prompt = pp:FindFirstChild("ProximityPrompt")
            if prompt and prompt.Enabled then
                local dist = (hrpPos - pp.Position).Magnitude
                if dist < shortestDist then
                    shortestDist = dist
                    nearestPrompt = prompt
                    nearestPart = pp
                end
            end
        end
    end
    return nearestPrompt, nearestPart
end

-- Check Museum Door
local function isMuseumOpen()
    local museum = workspace:FindFirstChild("MUSEUM")
    if not museum then return false end
    if museum:FindFirstChild("MuseumDoor") then
        return false
    end
    return true
end

-- Get Nearest Art
local function getNearestArt()
    local museum = workspace:FindFirstChild("MUSEUM")
    if not museum then return nil, nil end
    local artFolder = museum:FindFirstChild("Art")
    if not artFolder then return nil, nil end
    
    local hrp = getHRP()
    if not hrp then return nil, nil end
    
    local hrpPos = hrp.Position
    local nearestPrompt, nearestPart, shortestDist = nil, nil, math.huge
    
    for _, artModel in ipairs(artFolder:GetChildren()) do
        local mainPart = artModel:FindFirstChild("MainPart")
        if mainPart then
            local prompt = mainPart:FindFirstChild("ProximityPrompt")
            if prompt and prompt.Enabled then
                local dist = (hrpPos - mainPart.Position).Magnitude
                if dist < shortestDist then
                    shortestDist = dist
                    nearestPrompt = prompt
                    nearestPart = mainPart
                end
            end
        end
    end
    return nearestPrompt, nearestPart
end

-- Process target (robbery)
local function processTarget(part, prompt)
    if not isRunning then return false end
    
    local ok, status = tpToPart(part)
    if not ok then return false, status end
    
    local originalHold = prompt.HoldDuration
    prompt.HoldDuration = 0
    
    spamPrompt(prompt)
    
    if prompt.Parent then
        prompt.HoldDuration = originalHold
    end
    
    return true
end

-- Cooldown sequence
local function doCooldown()
    if not isRunning then return end
    
    resetCamera()
    tpCoords(Vector3.new(1034, -5, 174)) -- Cooldown spot (no limit)
    button.Text = "COOLDOWN"
    task.wait(CONFIG.COOLDOWN_TIME)
    
    -- Reset counter for next cycle
    longTeleportCount = 0
    
    -- Return to bank (this will be count 1 of next cycle if >200)
    if isRunning then
        tpLimited(Vector3.new(917, 3, 2589))
        task.wait(CONFIG.CHECK_LOAD_TIME)
    end
end

-- Main Logic
local function autoRob()
    -- Reset counter at start
    longTeleportCount = 0
    
    -- INITIAL STARTUP (bypasses limit)
    if not startupComplete then
        button.Text = "STARTUP"
        
        tpCoords(Vector3.new(980, 2, 541))
        task.wait(CONFIG.STARTUP_WAIT_1)
        
        if isRunning then
            tpCoords(Vector3.new(917, 3, 2589))
            task.wait(CONFIG.STARTUP_WAIT_2)
        end
        
        startupComplete = true
        longTeleportCount = 0
    end
    
    -- Main loop
    while isRunning do
        local limitReached = false
        
        -- PHASE 1: BANK
        button.Text = "CHECK BANK"
        local success, status = tpLimited(Vector3.new(917, 3, 2589))
        
        if not success and status == "LIMIT_HIT" then
            -- Can't reach bank, go cooldown immediately
            doCooldown()
        else
            task.wait(CONFIG.CHECK_LOAD_TIME)
            
            local btnPrompt, btnPart = getBankButton()
            local moneyExists = getNearestMoney()
            
            if (btnPrompt and btnPrompt.Enabled) or moneyExists then
                
                -- Button available?
                if btnPrompt and btnPrompt.Enabled then
                    button.Text = "BUTTON"
                    processTarget(btnPart, btnPrompt)
                    
                    -- 10-second money mode
                    local startTime = tick()
                    while isRunning do
                        local elapsed = tick() - startTime
                        local mPrompt, mPart = getNearestMoney()
                        
                        if mPrompt then
                            button.Text = "MONEY"
                            local ok, stat = processTarget(mPart, mPrompt)
                            if not ok and stat == "LIMIT_HIT" then
                                limitReached = true
                                break -- Exit money loop, go to cooldown
                            end
                            task.wait()
                        else
                            if elapsed >= CONFIG.BUTTON_MONEY_WAIT then
                                break
                            else
                                button.Text = "WAIT " .. math.ceil(CONFIG.BUTTON_MONEY_WAIT - elapsed)
                                task.wait(0.5)
                            end
                        end
                    end
                    
                elseif moneyExists then
                    -- No button, just money
                    while isRunning do
                        local mPrompt, mPart = getNearestMoney()
                        if not mPrompt then break end
                        
                        button.Text = "MONEY"
                        local ok, stat = processTarget(mPart, mPrompt)
                        if not ok and stat == "LIMIT_HIT" then
                            limitReached = true
                            break
                        end
                        task.wait()
                    end
                end
            end
            
            -- PHASE 2: MUSEUM (only if limit not reached)
            if isRunning and not limitReached then
                button.Text = "CHECK MUSEUM"
                local ok2, stat2 = tpLimited(Vector3.new(109, 3, 1866))
                
                if not ok2 and stat2 == "LIMIT_HIT" then
                    limitReached = true
                else
                    task.wait(CONFIG.CHECK_LOAD_TIME)
                    
                    if isMuseumOpen() then
                        local artPrompt, artPart = getNearestArt()
                        
                        if artPrompt then
                            button.Text = "ART"
                            local ok3, stat3 = processTarget(artPart, artPrompt)
                            if not ok3 and stat3 == "LIMIT_HIT" then
                                limitReached = true
                            else
                                -- Process remaining art pieces
                                while isRunning and not limitReached do
                                    local nextPrompt, nextPart = getNearestArt()
                                    if not nextPrompt then break end
                                    
                                    button.Text = "ART"
                                    local ok4, stat4 = processTarget(nextPart, nextPrompt)
                                    if not ok4 and stat4 == "LIMIT_HIT" then
                                        limitReached = true
                                        break
                                    end
                                    task.wait()
                                end
                            end
                        else
                            button.Text = "NO ART"
                            task.wait(0.5)
                        end
                    else
                        button.Text = "DOOR CLOSED"
                        task.wait(1)
                    end
                end
            end
            
            -- PHASE 3: COOLDOWN (always happens after processing, or if limit hit)
            if isRunning then
                doCooldown()
            end
        end
    end
    
    resetCamera()
    updateButton()
    button.Text = "START AUTO"
end

-- Toggle
button.MouseButton1Click:Connect(function()
    isRunning = not isRunning
    
    if isRunning then
        updateButton()
        task.spawn(autoRob)
    else
        updateButton()
        resetCamera()
    end
end)

-- Handle death
player.CharacterAdded:Connect(function(char)
    resetCamera()
    task.spawn(function()
        char:WaitForChild("HumanoidRootPart", 5)
    end)
end)

print("[AUTO] Loaded")




