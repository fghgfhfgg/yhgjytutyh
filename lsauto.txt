local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local task_wait = task.wait

local CONFIG = {
    SPAM_DELAY = 0.05,
    PROCESS_DURATION = 0.3,
    CHECK_LOAD_TIME = 0,
    COOLDOWN_TIME = 9,
    STARTUP_WAIT_1 = 1,
    STARTUP_WAIT_2 = 0,
    BUTTON_MONEY_WAIT = 20,
    MAX_LONG_TELEPORTS = 2,
    RESET_ATTEMPT_INTERVAL = 0.2,
    RESET_TIMEOUT = 10,
    MUSEUM_ROB_TIMEOUT = 30,
    BANK_ROB_TIMEOUT = 60,
}

local isRunning = false
local startupComplete = false

local longTeleportCount = 0
local cooldownAllowed = true
local longTeleportsSinceReset = 0
local REQUIRED_LONG_TELEPORTS_AFTER_RESET = 2

local BANK_POS = Vector3.new(917, 3, 2589)
local STARTUP_POS = Vector3.new(980, 2, 541)
local MUSEUM_POS = Vector3.new(109, 3, 1866)

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BankAuto"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.new(0, 140, 0, 50)
button.Position = UDim2.new(0, 20, 0.5, -25)
button.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
button.Text = "START AUTO"
button.TextColor3 = Color3.new(1, 1, 1)
button.TextSize = 18
button.Font = Enum.Font.SourceSansBold
button.Parent = screenGui

Instance.new("UICorner", button).CornerRadius = UDim.new(0, 6)

local function setButtonText(txt)
    if button.Text ~= txt then
        button.Text = txt
    end
end

local function updateButton()
    if isRunning then
        button.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
        setButtonText("STOP")
    else
        button.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
        setButtonText("START AUTO")
    end
end

local function resetCamera()
    if camera.CameraType ~= Enum.CameraType.Custom then
        camera.CameraType = Enum.CameraType.Custom
    end
end

local function getHRP(timeout)
    timeout = timeout or 5
    local char = player.Character
    if char then
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then return hrp end
    end
    local start = tick()
    while tick() - start < timeout do
        char = player.Character
        if char then
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then return hrp end
        end
        task_wait(0.1)
    end
    return nil
end

local function distSq(a, b)
    local dx, dy, dz = a.X - b.X, a.Y - b.Y, a.Z - b.Z
    return dx*dx + dy*dy + dz*dz
end

local lastTeleportName = nil
local function isLongTeleportPair(fromName, toName)
    if not fromName or not toName then return false end
    local key = fromName .. "," .. toName
    local longPairs = {
        ["STARTUP,BANK"] = true, ["BANK,STARTUP"] = true,
        ["STARTUP,MUSEUM"] = true, ["MUSEUM,STARTUP"] = true,
        ["BANK,MUSEUM"] = true, ["MUSEUM,BANK"] = true,
    }
    return longPairs[key] == true
end

local function teleportToCoords(pos, teleportName)
    local hrp = getHRP(5)
    if not hrp then return false, "NO_HRP" end

    if lastTeleportName and teleportName and isLongTeleportPair(lastTeleportName, teleportName) then
        longTeleportCount = longTeleportCount + 1
        if not cooldownAllowed then
            longTeleportsSinceReset = longTeleportsSinceReset + 1
            if longTeleportsSinceReset >= REQUIRED_LONG_TELEPORTS_AFTER_RESET then
                cooldownAllowed = true
                longTeleportsSinceReset = 0
                longTeleportCount = 0
            end
        end

        if longTeleportCount > CONFIG.MAX_LONG_TELEPORTS then
            return false, "LIMIT_HIT"
        end
    end

    hrp.CFrame = CFrame.new(pos.X, pos.Y, pos.Z)
    lastTeleportName = teleportName
    return true, "OK"
end

local function teleportToPartAndLook(part, teleportName)
    local hrp = getHRP(5)
    if not hrp or not part then return false, "INVALID" end

    if lastTeleportName and teleportName and isLongTeleportPair(lastTeleportName, teleportName) then
        longTeleportCount = longTeleportCount + 1
        if not cooldownAllowed then
            longTeleportsSinceReset = longTeleportsSinceReset + 1
            if longTeleportsSinceReset >= REQUIRED_LONG_TELEPORTS_AFTER_RESET then
                cooldownAllowed = true
                longTeleportsSinceReset = 0
                longTeleportCount = 0
            end
        end

        if longTeleportCount > CONFIG.MAX_LONG_TELEPORTS then
            return false, "LIMIT_HIT"
        end
    end

    hrp.CFrame = CFrame.new(part.Position + Vector3.new(0, 3, 0))

    if camera.CameraType ~= Enum.CameraType.Scriptable then
        camera.CameraType = Enum.CameraType.Scriptable
    end
    camera.CFrame = CFrame.new(part.Position + Vector3.new(0, 4, 0), part.Position)

    lastTeleportName = teleportName
    return true, "OK"
end

local function spamPrompt(prompt)
    if not prompt or not prompt:IsA("ProximityPrompt") then return end
    local startT = tick()
    while isRunning and (tick() - startT) < CONFIG.PROCESS_DURATION do
        pcall(function() fireproximityprompt(prompt) end)
        task_wait(CONFIG.SPAM_DELAY)
    end
end

local function getBankButton()
    local bank = workspace:FindFirstChild("BANK")
    if not bank then return nil, nil end
    local panel = bank:FindFirstChild("ButtonPanel")
    if not panel then return nil, nil end
    local pPart = panel:FindFirstChild("PromptPart")
    if not pPart then return nil, nil end
    return pPart:FindFirstChild("ProximityPrompt"), pPart
end

local function getNearestMoney()
    local bank = workspace:FindFirstChild("BANK")
    if not bank then return nil, nil end
    local boxes = bank:FindFirstChild("MoneyBoxes")
    if not boxes then return nil, nil end

    local hrp = getHRP(1)
    if not hrp then return nil, nil end

    local hrpPos = hrp.Position
    local nearestPrompt, nearestPart, shortestDist = nil, nil, math.huge

    for _, box in ipairs(boxes:GetChildren()) do
        local pp = box:FindFirstChild("PromptPart")
        if pp then
            local prompt = pp:FindFirstChild("ProximityPrompt")
            if prompt and prompt.Enabled then
                local d = distSq(hrpPos, pp.Position)
                if d < shortestDist then
                    shortestDist = d
                    nearestPrompt = prompt
                    nearestPart = pp
                end
            end
        end
    end
    return nearestPrompt, nearestPart
end

local function isMuseumOpen()
    local museum = workspace:FindFirstChild("MUSEUM")
    if not museum then return false end
    if museum:FindFirstChild("MuseumDoor") then
        return false
    end
    return true
end

local function getNearestArt()
    local museum = workspace:FindFirstChild("MUSEUM")
    if not museum then return nil, nil end
    local artFolder = museum:FindFirstChild("Art")
    if not artFolder then return nil, nil end

    local hrp = getHRP(1)
    if not hrp then return nil, nil end

    local hrpPos = hrp.Position
    local nearestPrompt, nearestPart, shortestDist = nil, nil, math.huge

    for _, artModel in ipairs(artFolder:GetChildren()) do
        local mainPart = artModel:FindFirstChild("MainPart")
        if mainPart then
            local prompt = mainPart:FindFirstChild("ProximityPrompt")
            if prompt and prompt.Enabled then
                local d = distSq(hrpPos, mainPart.Position)
                if d < shortestDist then
                    shortestDist = d
                    nearestPrompt = prompt
                    nearestPart = mainPart
                end
            end
        end
    end
    return nearestPrompt, nearestPart
end

local function processTarget(part, prompt, teleportName)
    if not isRunning then return false end

    local ok, status = teleportToPartAndLook(part, teleportName)
    if not ok then return false, status end

    local originalHold = prompt.HoldDuration
    prompt.HoldDuration = 0

    spamPrompt(prompt)

    if prompt.Parent then
        prompt.HoldDuration = originalHold
    end

    return true, "OK"
end

local function resetCharacter()
    local events = ReplicatedStorage:FindFirstChild("Events")
    if not events then return end
    local WeaponEvent = events:FindFirstChild("WeaponEvent")
    if WeaponEvent then
        pcall(function() WeaponEvent:FireServer("Reset") end)
    end
end

local function doCooldown(forceTeleportMuseum)
    if not isRunning then return end

    if not cooldownAllowed then
        setButtonText("RESET BLOCKED")
        return
    end

    cooldownAllowed = false
    longTeleportsSinceReset = 0

    setButtonText("RESETTING")

    if forceTeleportMuseum then
        setButtonText("TIMEOUT - TP MUSEUM")
        teleportToCoords(MUSEUM_POS, "MUSEUM")
        task_wait(0.5)
    end

    local resetStartTime = tick()
    local resetTimedOut = false

    while isRunning do
        if (tick() - resetStartTime) >= CONFIG.RESET_TIMEOUT then
            resetTimedOut = true
            break
        end

        local humanoid = player.Character and player.Character:FindFirstChild("Humanoid")
        if humanoid and humanoid.Health <= 0 then
            break
        end

        resetCharacter()
        task_wait(CONFIG.RESET_ATTEMPT_INTERVAL)
    end

    if resetTimedOut then
        setButtonText("RESET TIMEOUT")
        teleportToCoords(MUSEUM_POS, "MUSEUM")
        task_wait(0.5)
        resetCharacter()
        task_wait(0.5)
    end

    if not player.Character then
        player.CharacterAdded:Wait()
    end

    local char = player.Character
    if char then
        char:WaitForChild("HumanoidRootPart", 5)
        char:WaitForChild("Humanoid", 5)
    end

    resetCamera()
    camera.CameraSubject = char and char:FindFirstChild("Humanoid") or nil

    setButtonText("COOLDOWN")
    task_wait(CONFIG.COOLDOWN_TIME)
end

local function autoRob()
    longTeleportCount = 0
    lastTeleportName = nil
    longTeleportsSinceReset = 0
    cooldownAllowed = true

    if not startupComplete then
        setButtonText("STARTUP")
        teleportToCoords(STARTUP_POS, "STARTUP")
        task_wait(CONFIG.STARTUP_WAIT_1)

        if isRunning then
            teleportToCoords(BANK_POS, "BANK")
            task_wait(CONFIG.STARTUP_WAIT_2)
        end

        startupComplete = true
        longTeleportCount = 0
    end

    while isRunning do
        local limitReached = false

        setButtonText("CHECK BANK")
        local ok, status = teleportToCoords(BANK_POS, "BANK")

        if not ok and status == "LIMIT_HIT" then
            if cooldownAllowed then
                doCooldown()
            else
                setButtonText("WAIT TELEPORTS")
                task_wait(1)
            end
        else
            task_wait(CONFIG.CHECK_LOAD_TIME)

            local btnPrompt, btnPart = getBankButton()
            local mPrompt, mPart = getNearestMoney()

            if (btnPrompt and btnPrompt.Enabled) or mPrompt then
                local bankStartTime = tick()
                local bankTimedOut = false

                if btnPrompt and btnPrompt.Enabled then
                    setButtonText("BUTTON")
                    processTarget(btnPart, btnPrompt, "BANK")

                    local startTime = tick()
                    while isRunning do
                        if (tick() - bankStartTime) >= CONFIG.BANK_ROB_TIMEOUT then
                            bankTimedOut = true
                            setButtonText("BANK TIMEOUT")
                            break
                        end

                        local mPrompt2, mPart2 = getNearestMoney()
                        if mPrompt2 then
                            setButtonText("MONEY")
                            local ok2, stat2 = processTarget(mPart2, mPrompt2, "BANK")
                            if not ok2 and stat2 == "LIMIT_HIT" then
                                limitReached = true
                                break
                            end
                            task_wait()
                        else
                            local elapsed = tick() - startTime
                            if elapsed >= CONFIG.BUTTON_MONEY_WAIT then
                                break
                            else
                                setButtonText("WAIT " .. math.ceil(CONFIG.BUTTON_MONEY_WAIT - elapsed))
                                task_wait(0.5)
                            end
                        end
                    end

                elseif mPrompt then
                    while isRunning do
                        if (tick() - bankStartTime) >= CONFIG.BANK_ROB_TIMEOUT then
                            bankTimedOut = true
                            setButtonText("BANK TIMEOUT")
                            break
                        end

                        local mPrompt2, mPart2 = getNearestMoney()
                        if not mPrompt2 then break end

                        setButtonText("MONEY")
                        local ok2, stat2 = processTarget(mPart2, mPrompt2, "BANK")
                        if not ok2 and stat2 == "LIMIT_HIT" then
                            limitReached = true
                            break
                        end
                        task_wait()
                    end
                end

                if bankTimedOut then
                    if cooldownAllowed then
                        doCooldown(true)
                    else
                        setButtonText("WAIT TELEPORTS")
                        task_wait(1)
                    end
                    continue
                end
            end

            if isRunning and not limitReached then
                setButtonText("CHECK MUSEUM")
                local ok2, stat2 = teleportToCoords(MUSEUM_POS, "MUSEUM")

                if not ok2 and stat2 == "LIMIT_HIT" then
                    limitReached = true
                else
                    task_wait(CONFIG.CHECK_LOAD_TIME)

                    if isMuseumOpen() then
                        local artPrompt, artPart = getNearestArt()
                        local museumStartTime = tick()
                        local museumTimedOut = false

                        if artPrompt then
                            setButtonText("ART")
                            local ok3, stat3 = processTarget(artPart, artPrompt, "MUSEUM")
                            if not ok3 and stat3 == "LIMIT_HIT" then
                                limitReached = true
                            else
                                while isRunning and not limitReached do
                                    if (tick() - museumStartTime) >= CONFIG.MUSEUM_ROB_TIMEOUT then
                                        museumTimedOut = true
                                        setButtonText("MUSEUM TIMEOUT")
                                        break
                                    end

                                    local nextPrompt, nextPart = getNearestArt()
                                    if not nextPrompt then break end

                                    setButtonText("ART")
                                    local ok4, stat4 = processTarget(nextPart, nextPrompt, "MUSEUM")
                                    if not ok4 and stat4 == "LIMIT_HIT" then
                                        limitReached = true
                                        break
                                    end
                                    task_wait()
                                end
                            end

                            if museumTimedOut then
                                if cooldownAllowed then
                                    doCooldown(true)
                                else
                                    setButtonText("WAIT TELEPORTS")
                                    task_wait(1)
                                end
                                continue
                            end
                        else
                            setButtonText("NO ART")
                            task_wait(0.1)
                        end
                    else
                        setButtonText("DOOR CLOSED")
                        task_wait(1)
                    end
                end
            end

            if isRunning then
                if cooldownAllowed then
                    doCooldown()
                else
                    setButtonText("WAIT TELEPORTS")
                    task_wait(1)
                end
            end
        end
    end

    resetCamera()
    updateButton()
    setButtonText("START AUTO")
end

button.MouseButton1Click:Connect(function()
    isRunning = not isRunning

    if isRunning then
        updateButton()
        task.spawn(autoRob)
    else
        updateButton()
        resetCamera()
    end
end)

player.CharacterAdded:Connect(function(char)
    resetCamera()
end)
